
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Agent</title>
    
    <meta name="author" content="Lucas AllanJerry DAntonio">

    <!-- Enable responsive viewport -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- Le styles -->
    <link href="/assets/themes/twitter/bootstrap/css/bootstrap.2.2.2.min.css" rel="stylesheet">
    <link href="/assets/themes/twitter/css/style.css?body=1" rel="stylesheet" type="text/css" media="all">

    <!-- Le fav and touch icons -->
  <!-- Update these with your own images
    <link rel="shortcut icon" href="images/favicon.ico">
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
  -->

    <!-- atom & rss feed -->
    <link href="" type="application/atom+xml" rel="alternate" title="Sitewide ATOM Feed">
    <link href="" type="application/rss+xml" rel="alternate" title="Sitewide RSS Feed">

  </head>

  <body>
    <div class="navbar">
      <div class="navbar-inner">
        <div class="container-narrow">
          <a class="brand" href="/">Concurrent-ruby</a>
          <ul class="nav">
            
            
            


  
    
      
      	
      	<li><a href="/about/index.html">About</a></li>
      	
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/documentation/index.html">Documentation</a></li>
      	
      
    
  
    
      
    
  
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  



          </ul>
        </div>
      </div>
    </div>

    <div class="container-narrow">

      <div class="content">
        
<div class="page-header">
  <h1>Agent </h1>
</div>

<div class="row-fluid">
  <div class="span12">
    <h1 id="secret_agent_man">Secret Agent Man</h1>

<p><code>Agent</code>s are inspired by <a href="http://clojure.org/">Clojure’s</a> <a href="http://clojure.org/agents">agent</a> function. An <code>Agent</code> is a single atomic value that represents an identity. The current value of the <code>Agent</code> can be requested at any time (<code>deref</code>). Each <code>Agent</code> has a work queue and operates on the global thread pool (see below). Consumers can <code>post</code> code blocks to the <code>Agent</code>. The code block (function) will receive the current value of the <code>Agent</code> as its sole parameter. The return value of the block will become the new value of the <code>Agent</code>. <code>Agent</code>s support two error handling modes: fail and continue. A good example of an <code>Agent</code> is a shared incrementing counter, such as the score in a video game.</p>

<p>An <code>Agent</code> must be initialize with an initial value. This value is always accessible via the <code>value</code> (or <code>deref</code>) methods. Code blocks sent to the <code>Agent</code> will be processed in the order received. As each block is processed the current value is updated with the result from the block. This update is an atomic operation so a <code>deref</code> will never block and will always return the current value.</p>

<p>When an <code>Agent</code> is created it may be given an optional <code>validate</code> block and zero or more <code>rescue</code> blocks. When a new value is calculated the value will be checked against the validator, if present. If the validator returns <code>true</code> the new value will be accepted. If it returns <code>false</code> it will be rejected. If a block raises an exception during execution the list of <code>rescue</code> blocks will be seacrhed in order until one matching the current exception is found. That <code>rescue</code> block will then be called an passed the exception object. If no matching <code>rescue</code> block is found, or none were configured, then the exception will be suppressed.</p>

<p><code>Agent</code>s also implement Ruby’s <a href="http://ruby-doc.org/stdlib-2.0/libdoc/observer/rdoc/Observable.html">Observable</a>. Code that observes an <code>Agent</code> will receive a callback with the new value any time the value is changed.</p>

<h2 id="copy_options">Copy Options</h2>

<p>Object references in Ruby are mutable. This can lead to serious problems when the value of an <code>Agent</code> is a mutable reference. Which is always the case unless the value is a <code>Fixnum</code>, <code>Symbol</code>, or similar “primative” data type. Each <code>Agent</code> instance can be configured with a few options that can help protect the program from potentially dangerous operations. Each of these options can be optionally set when the <code>Agent</code> is created:</p>

<ul>
<li><code>:dup_on_deref</code> when true the <code>Agent</code> will call the <code>#dup</code> method on the <code>value</code> object every time the <code>#value</code> methid is called (default: false)</li>

<li><code>:freeze_on_deref</code> when true the <code>Agent</code> will call the <code>#freeze</code> method on the <code>value</code> object every time the <code>#value</code> method is called (default: false)</li>

<li><code>:copy_on_deref</code> when given a <code>Proc</code> object the <code>Proc</code> will be run every time the <code>#value</code> method is called. The <code>Proc</code> will be given the current <code>value</code> as its only parameter and the result returned by the block will be the return value of the <code>#value</code> call. When <code>nil</code> this option will be ignored (default: nil)</li>
</ul>

<h2 id="examples">Examples</h2>

<p>A simple example:</p>

<pre class="ruby"><code class="ruby">
require 'concurrent'

score = Concurrent::Agent.new(10)
score.value #=&gt; 10

score &lt;&lt; proc{|current| current + 100 }
sleep(0.1)
score.value #=&gt; 110

score &lt;&lt; proc{|current| current * 2 }
sleep(0.1)
score.value #=&gt; 220

score &lt;&lt; proc{|current| current - 50 }
sleep(0.1)
score.value #=&gt; 170
</code></pre>

<p>With validation and error handling:</p>

<pre class="ruby"><code class="ruby">
score = Concurrent::Agent.new(0).validate{|value| value &lt;= 1024 }.
          rescue(NoMethodError){|ex| puts &quot;Bam!&quot; }.
          rescue(ArgumentError){|ex| puts &quot;Pow!&quot; }.
          rescue{|ex| puts &quot;Boom!&quot; }
score.value #=&gt; 0

score &lt;&lt; proc{|current| current + 2048 }
sleep(0.1)
score.value #=&gt; 0

score &lt;&lt; proc{|current| raise ArgumentError }
sleep(0.1)
#=&gt; puts &quot;Pow!&quot;
score.value #=&gt; 0

score &lt;&lt; proc{|current| current + 100 }
sleep(0.1)
score.value #=&gt; 100
</code></pre>

<p>With observation:</p>

<pre class="ruby"><code class="ruby">
bingo = Class.new{
  def update(time, score)
    puts &quot;Bingo! [score: #{score}, time: #{time}]&quot; if score &gt;= 100
  end
}.new

score = Concurrent::Agent.new(0)
score.add_observer(bingo)

score &lt;&lt; proc{|current| sleep(0.1); current += 30 }
score &lt;&lt; proc{|current| sleep(0.1); current += 30 }
score &lt;&lt; proc{|current| sleep(0.1); current += 30 }
score &lt;&lt; proc{|current| sleep(0.1); current += 30 }

sleep(1)
#=&gt; Bingo! [score: 120, time: 2013-07-22 21:26:08 -0400]
</code></pre>

<h2 id="copyright">Copyright</h2>

<p><em>Concurrent Ruby</em> is Copyright © 2013 <a href="https://twitter.com/jerrydantonio">Jerry D’Antonio</a>. It is free software and may be redistributed under the terms specified in the LICENSE file.</p>

<h2 id="license">License</h2>

<p>Released under the MIT license.</p>

<p>http://www.opensource.org/licenses/mit-license.php</p>

<blockquote>
<p>Permission is hereby granted, free of charge, to any person obtaining a copy<br />of this software and associated documentation files (the “Software”), to deal<br />in the Software without restriction, including without limitation the rights<br />to use, copy, modify, merge, publish, distribute, sublicense, and/or sell<br />copies of the Software, and to permit persons to whom the Software is<br />furnished to do so, subject to the following conditions:</p>

<p>The above copyright notice and this permission notice shall be included in<br />all copies or substantial portions of the Software.</p>

<p>THE SOFTWARE IS PROVIDED “AS IS”, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR<br />IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,<br />FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE<br />AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER<br />LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,<br />OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN<br />THE SOFTWARE.</p>
</blockquote>
  </div>
</div>


      </div>
      <hr>
      <footer>
      </footer>

    </div>

    
  </body>
</html>

